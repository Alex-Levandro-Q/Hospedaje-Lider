generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id           Int      @id @default(autoincrement())
  nombre       String
  apellidos    String
  email        String   @unique
  fechaNac     DateTime
  numeroCarnet String   @unique
  rol          String   @default("gerente")
  password     String
  fotoCI1      String?
  fotoCI2      String?
  activo       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  reservas         Reserva[]
  checkins         CheckInOut[]
  registrosCheckIn CheckInOut[] @relation("RegistradorCheckInOut")

  @@map("usuarios")
}

model Servicio {
  id        Int      @id @default(autoincrement())
  nombre    String
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  habitaciones HabitacionServicio[]
  reservas     ReservaServicio[]

  @@map("servicios")
}

model Habitacion {
  id               Int      @id @default(autoincrement())
  codigo           String   @unique
  nombre           String
  tipoReserva      String // "hora", "noche", "mes"
  precioBase       Decimal  @db.Decimal(10, 2)
  precioHora       Decimal? @db.Decimal(10, 2)
  precioNoche      Decimal? @db.Decimal(10, 2)
  precioMes        Decimal? @db.Decimal(10, 2)
  horasMinimas     Int?     @default(3)
  cantidadPersonas Int      @default(1)
  imagen1          String?
  imagen2          String?
  imagen3          String?
  estado           String   @default("disponible") // "disponible", "ocupada"
  activa           Boolean  @default(true)
  limpieza         Boolean  @default(false)
  descripcion      String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  servicios HabitacionServicio[]
  reservas  Reserva[]

  @@map("habitaciones")
}

model HabitacionServicio {
  id           Int @id @default(autoincrement())
  habitacionId Int
  servicioId   Int

  habitacion Habitacion @relation(fields: [habitacionId], references: [id], onDelete: Cascade)
  servicio   Servicio   @relation(fields: [servicioId], references: [id], onDelete: Cascade)

  @@unique([habitacionId, servicioId])
  @@map("habitacion_servicios")
}

model Reserva {
  id           Int      @id @default(autoincrement())
  fechaInicio  DateTime
  fechaFin     DateTime
  horaInicio   String?
  horaFin      String?
  horaCheckout String? // Hora límite de checkout (12:00 PM para día/mes)
  tipoReserva  String // "hora", "noche", "mes"
  cantidad     Int // cantidad de horas, noches o meses
  montoTotal   Decimal  @db.Decimal(10, 2)
  tipoPago     String   @default("qr") // "qr", "efectivo"
  comprobante  String? // imagen del comprobante
  qrId         Int? // QR usado para el pago
  estado       String   @default("pendiente") // "pendiente", "confirmada", "cancelada", "completada", "liberada"
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  usuarioId    Int
  habitacionId Int

  usuario    Usuario           @relation(fields: [usuarioId], references: [id])
  habitacion Habitacion        @relation(fields: [habitacionId], references: [id])
  qr         QR?               @relation(fields: [qrId], references: [id])
  servicios  ReservaServicio[]
  checkins   CheckInOut[]

  @@map("reservas")
}

model CheckInOut {
  id            Int      @id @default(autoincrement())
  tipo          String // "checkin", "checkout"
  fechaHora     DateTime @default(now())
  observaciones String?
  registradoPor Int // ID del usuario que registra (admin/gerente)
  createdAt     DateTime @default(now())

  reservaId Int
  usuarioId Int // Usuario que hace check-in/out

  reserva     Reserva @relation(fields: [reservaId], references: [id], onDelete: Cascade)
  usuario     Usuario @relation(fields: [usuarioId], references: [id])
  registrador Usuario @relation("RegistradorCheckInOut", fields: [registradoPor], references: [id])

  @@map("checkin_checkout")
}

model ReservaServicio {
  id         Int @id @default(autoincrement())
  reservaId  Int
  servicioId Int

  reserva  Reserva  @relation(fields: [reservaId], references: [id], onDelete: Cascade)
  servicio Servicio @relation(fields: [servicioId], references: [id], onDelete: Cascade)

  @@unique([reservaId, servicioId])
  @@map("reserva_servicios")
}

model QR {
  id          Int      @id @default(autoincrement())
  nombre      String
  imagen      String
  fechaInicio DateTime
  fechaFin    DateTime
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  reservas Reserva[]

  @@map("qrs")
}
